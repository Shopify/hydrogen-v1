"use strict";(self.webpackChunkdocs_v_1=self.webpackChunkdocs_v_1||[]).push([[6434],{4796:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>g});var t=a(8168),r=(a(6540),a(5680));const o={},i="Manage caching",l={unversionedId:"tutorials/querying/manage-caching",id:"tutorials/querying/manage-caching",title:"Manage caching",description:"Hydrogen 2.0 is out now. These archival Hydrogen 1.0 docs are provided only to assist developers during their upgrade process. Please migrate as soon as possible.",source:"@site/docs/tutorials/querying/manage-caching.md",sourceDirName:"tutorials/querying",slug:"/tutorials/querying/manage-caching",permalink:"/hydrogen-v1/tutorials/querying/manage-caching",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"hydrogen",previous:{title:"Caching",permalink:"/hydrogen-v1/tutorials/querying/cache"},next:{title:"Preload queries",permalink:"/hydrogen-v1/tutorials/querying/preload-queries"}},s={},g=[{value:"Disable caching",id:"disable-caching",level:2},{value:"Create a caching strategy",id:"create-a-caching-strategy",level:2},{value:"Modify sub-request caching",id:"modify-sub-request-caching",level:2},{value:"<code>useShopQuery</code>",id:"useshopquery",level:3},{value:"<code>fetchSync</code>",id:"fetchsync",level:3},{value:"Enable sub-request caching",id:"enable-sub-request-caching",level:3},{value:"Modify full-page caching",id:"modify-full-page-caching",level:2},{value:"Manage caching in development",id:"manage-caching-in-development",level:2},{value:"Enable logging for the cache API status",id:"enable-logging-for-the-cache-api-status",level:3},{value:"Enable logging for cache control headers",id:"enable-logging-for-cache-control-headers",level:3},{value:"Bust query cache busting on build",id:"bust-query-cache-busting-on-build",level:3},{value:"Caching in production",id:"caching-in-production",level:2},{value:"Worker-based runtimes",id:"worker-based-runtimes",level:3},{value:"Node.js-based runtimes",id:"nodejs-based-runtimes",level:3},{value:"Related hooks",id:"related-hooks",level:2},{value:"Next steps",id:"next-steps",level:2}],c={toc:g},u="wrapper";function p(e){let{components:n,...a}=e;return(0,r.yg)(u,(0,t.A)({},c,a,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"manage-caching"},"Manage caching"),(0,r.yg)("admonition",{type:"tip"},(0,r.yg)("p",{parentName:"admonition"},"Hydrogen 2.0 is out now. These archival Hydrogen 1.0 docs are provided only to assist developers during their upgrade process. Please ",(0,r.yg)("a",{parentName:"p",href:"/migrate"},"migrate")," as soon as possible.")),(0,r.yg)("p",null,"Combined with ",(0,r.yg)("a",{parentName:"p",href:"/tutorials/streaming-ssr/"},"streaming server-side rendering"),", caching ensures that buyers get the quickest response possible while also displaying the latest data."),(0,r.yg)("h2",{id:"disable-caching"},"Disable caching"),(0,r.yg)("p",null,"You should consider disabling caching on authenticated pages to prevent leaking personal identifying information."),(0,r.yg)("p",null,"To disable caching, use the ",(0,r.yg)("inlineCode",{parentName:"p"},"CacheNone()")," caching strategy."),(0,r.yg)("h2",{id:"create-a-caching-strategy"},"Create a caching strategy"),(0,r.yg)("p",null,"If you don't want to use the ",(0,r.yg)("a",{parentName:"p",href:"/hydrogen-v1/tutorials/querying/cache#caching-strategies"},"caching strategies provided by Hydrogen"),", then you can create your own to use in your project."),(0,r.yg)("p",null,"For example, you can create a cache control header with ",(0,r.yg)("inlineCode",{parentName:"p"},"max-age=30, must-revalidate, no-transform"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tsx"},"response.cache(\n  CacheCustom({\n    mode: 'must-revalidate, no-transform',\n    maxAge: 30,\n  })\n);\n")),(0,r.yg)("h2",{id:"modify-sub-request-caching"},"Modify sub-request caching"),(0,r.yg)("p",null,"Sub-request caching keeps pages loading quickly for end-users. All sub-request have the default ",(0,r.yg)("inlineCode",{parentName:"p"},"CacheShort")," strategy."),(0,r.yg)("h3",{id:"useshopquery"},(0,r.yg)("inlineCode",{parentName:"h3"},"useShopQuery")),(0,r.yg)("p",null,"The following example shows how to implement ",(0,r.yg)("a",{parentName:"p",href:"/hooks/global/useshopquery/"},(0,r.yg)("inlineCode",{parentName:"a"},"useShopQuery"))," for Shopify Storefront API queries:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-jsx"},"// /routes/my-products.server.jsx\n\n// Use a caching strategy provided by Hydrogen\nconst {data} = useShopQuery({\n  query: QUERY,\n  cache: CacheLong(),\n});\n")),(0,r.yg)("h3",{id:"fetchsync"},(0,r.yg)("inlineCode",{parentName:"h3"},"fetchSync")),(0,r.yg)("p",null,"The following example shows how to implement ",(0,r.yg)("a",{parentName:"p",href:"/hooks/global/fetchsync/"},(0,r.yg)("inlineCode",{parentName:"a"},"fetchSync"))," for third-party requests:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-jsx"},"// /routes/my-products.server.jsx\n\n// Use a caching strategy provided by Hydrogen\nconst data = fetchSync('https://my.3p.com/data.json', {\n  cache: CacheLong(),\n}).json();\n")),(0,r.yg)("p",null,"When the cached entry becomes stale, if the age of the entry is still within the ",(0,r.yg)("inlineCode",{parentName:"p"},"stale-while-revalidate")," window, then the stale version is returned and a new version is generated in the background."),(0,r.yg)("h3",{id:"enable-sub-request-caching"},"Enable sub-request caching"),(0,r.yg)("p",null,"Enable sub-request caching using an in-memory store."),(0,r.yg)("p",null,"Pass ",(0,r.yg)("inlineCode",{parentName:"p"},"devCache: true")," to the second parameter of the Hydrogen Vite plugin:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},"// /vite.config.js\n\nexport default defineConfig({\n  plugins: [hydrogen({devCache: true})],\n});\n")),(0,r.yg)("h2",{id:"modify-full-page-caching"},"Modify full-page caching"),(0,r.yg)("p",null,"It's helpful to cache the entire page response at the network edge and in the browser. This is the most useful for pages without dynamic or personalized data, like marketing pages or blog content. By default, Hydrogen implements a ",(0,r.yg)("inlineCode",{parentName:"p"},"CacheShort()")," strategy for all full-page requests."),(0,r.yg)("p",null,"To modify full-page caching options, use the ",(0,r.yg)("inlineCode",{parentName:"p"},"response")," property passed to the page server component:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-jsx"},"// /routes/my-products.server.jsx\n\nexport default function MyProducts({response}) {\n  response.cache(CacheLong());\n}\n")),(0,r.yg)("h2",{id:"manage-caching-in-development"},"Manage caching in development"),(0,r.yg)("p",null,"The following are common tasks for managing caching in development:"),(0,r.yg)("h3",{id:"enable-logging-for-the-cache-api-status"},"Enable logging for the cache API status"),(0,r.yg)("p",null,"Set ",(0,r.yg)("inlineCode",{parentName:"p"},"logger.showCacheApiStatus")," to ",(0,r.yg)("inlineCode",{parentName:"p"},"true")," in your ",(0,r.yg)("a",{parentName:"p",href:"/hydrogen-v1/tutorials/configuration/#logger"},"Hydrogen configuration file"),". The status of the cache updates on each query:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sh"},"[Cache] MISS   query shopInfo\n[Cache] MISS   query indexContent\n[Cache] PUT    query indexContent\n[Cache] MISS   query Localization\n")),(0,r.yg)("h3",{id:"enable-logging-for-cache-control-headers"},"Enable logging for cache control headers"),(0,r.yg)("p",null,"Set ",(0,r.yg)("inlineCode",{parentName:"p"},"logger.showCacheControlHeader")," to ",(0,r.yg)("inlineCode",{parentName:"p"},"true")," in your ",(0,r.yg)("a",{parentName:"p",href:"/hydrogen-v1/tutorials/configuration/#logger"},"Hydrogen configuration file"),"."),(0,r.yg)("h3",{id:"bust-query-cache-busting-on-build"},"Bust query cache busting on build"),(0,r.yg)("p",null,"Pass ",(0,r.yg)("inlineCode",{parentName:"p"},"{purgeQueryCacheOnBuild: true}")," to the second parameter of the Hydrogen Vite plugin:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},"// /vite.config.js\n\nexport default defineConfig({\n  plugins: [hydrogen({purgeQueryCacheOnBuild: true})],\n});\n")),(0,r.yg)("h2",{id:"caching-in-production"},"Caching in production"),(0,r.yg)("p",null,"Sub-request caching uses an instance of ",(0,r.yg)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/API/Cache"},"Cache")," passed to the entry point. You can manage caching in production for different runtimes."),(0,r.yg)("h3",{id:"worker-based-runtimes"},"Worker-based runtimes"),(0,r.yg)("p",null,"Provide a ",(0,r.yg)("inlineCode",{parentName:"p"},"cache")," option to ",(0,r.yg)("inlineCode",{parentName:"p"},"handleRequest"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},"// /worker.js\n\naddEventListener('fetch', (event) => {\n  event.respondWith(\n    handleEvent(event, {\n      // Your implementation of `Cache`. Defaults to `await caches.open` for Oxygen support.\n      cache: await caches.open('oxygen'),\n\n      // ...\n    })\n  );\n});\n")),(0,r.yg)("h3",{id:"nodejs-based-runtimes"},"Node.js-based runtimes"),(0,r.yg)("p",null,"Provide a ",(0,r.yg)("inlineCode",{parentName:"p"},"cache")," option to ",(0,r.yg)("inlineCode",{parentName:"p"},"hydrogenMiddleware"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},"// /server.js\n\napp.use(\n  '*',\n  hydrogenMiddleware({\n    // You need to provide a `Cache` implementation backed by something like Redis or Memcached.\n    cache: customCacheImplementation,\n    // ...\n  })\n);\n")),(0,r.yg)("p",null,"Full-page caching is powered completely by ",(0,r.yg)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control"},(0,r.yg)("inlineCode",{parentName:"a"},"cache-control")," headers on the Hydrogen response"),". By default, full-page caching is enabled as long as there is a ",(0,r.yg)("inlineCode",{parentName:"p"},"cache")," available."),(0,r.yg)("h2",{id:"related-hooks"},"Related hooks"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"/hooks/global/useshopquery/"},(0,r.yg)("inlineCode",{parentName:"a"},"useShopQuery"))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"/hooks/global/fetchsync/"},(0,r.yg)("inlineCode",{parentName:"a"},"fetchSync"))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"/hooks/global/usequery/"},(0,r.yg)("inlineCode",{parentName:"a"},"useQuery")))),(0,r.yg)("h2",{id:"next-steps"},"Next steps"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Improve your app's loading performance with ",(0,r.yg)("a",{parentName:"li",href:"/tutorials/streaming-ssr/"},"streaming SSR and Suspense"),".")))}p.isMDXComponent=!0},5680:(e,n,a)=>{a.d(n,{xA:()=>c,yg:()=>h});var t=a(6540);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function o(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function i(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?o(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function l(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=t.createContext({}),g=function(e){var n=t.useContext(s),a=n;return e&&(a="function"==typeof e?e(n):i(i({},n),e)),a},c=function(e){var n=g(e.components);return t.createElement(s.Provider,{value:n},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},d=t.forwardRef((function(e,n){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=g(a),d=r,h=u["".concat(s,".").concat(d)]||u[d]||p[d]||o;return a?t.createElement(h,i(i({ref:n},c),{},{components:a})):t.createElement(h,i({ref:n},c))}));function h(e,n){var a=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[u]="string"==typeof e?e:r,i[1]=l;for(var g=2;g<o;g++)i[g]=a[g];return t.createElement.apply(null,i)}return t.createElement.apply(null,a)}d.displayName="MDXCreateElement"}}]);